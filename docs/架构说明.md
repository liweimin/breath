# 架构说明

## 项目结构
- `index.html`：页面结构与控件定义。
- `style.css`：视觉样式、阶段动效、响应式布局。
- `app.js`：业务逻辑（计时、状态机、音频播放、导出渲染）。
- `assets/audio/`：呼气采样音频资源。
- `scripts/generate-audio-data.ps1`：生成可选 `audio-data.js`（用于 `file://` 场景补充）。
- `vercel.json`：静态路由配置（所有路径回退到 `index.html`）。

## 页面布局（当前）
- 主舞台卡片：展示呼吸球体与阶段倒计时信息。
- 控制卡片：包含参数设置、开始/暂停/继续/停止、下载音频。
- 底部联系区：展示问题反馈邮箱。
- 顶部引导说明卡：已移除（改为直接进入功能入口）。

## 运行时主流程
1. 页面加载后读取默认/缓存设置并绑定事件。
2. 点击开始：创建并解锁 `AudioContext`，进入阶段循环。
3. 阶段按顺序执行：吸气 -> 暂停1 -> 呼气 -> 暂停2。
4. 过程中实时更新：
- 当前阶段名称
- 阶段剩余倒计时
- 总剩余倒计时
- 球体动效状态
5. 结束后进入完成态，可重新开始。

## 音频架构
`app.js` 中由 `BreathAudio` 类统一管理：
- 主输出：`masterGain`（音量/静音控制）
- 空间效果：延迟 + 反馈 + 低通（用于提示音氛围）
- 背景雨声：运行时由噪声合成生成（非外部文件）

阶段与声音映射（当前）：
- 吸气：合成提示音（`playHoldDrop`）
- 暂停：合成低频鼓感音（`playInhaleLowDrum`）
- 呼气：采样音播放（`assets/audio/exhale-light-short.mp3`）

## 导出架构
导出入口：`handleDownloadMix`。

核心步骤：
1. 解析并校验参数。
2. 调 `buildSessionTimeline` 生成全程时间线（到分钟后“整轮结束再停”）。
3. 使用 `OfflineAudioContext` 离线渲染完整混音：
- 安排阶段提示音
- 加入雨声背景层
4. 将 `AudioBuffer` 编码为 WAV。
5. 触发浏览器下载并展示进度条。

## 关键状态管理
`state` 对象维护：
- 运行态：`idle / running / paused / finished`
- 会话计时信息：开始时间、暂停累计、总时长
- 当前阶段信息：索引、阶段结束时间、阶段时长
- 导出状态：`exportInProgress`

## 部署与路由
- 平台：Vercel（静态部署）
- 配置：`vercel.json` 使用 filesystem 优先 + 全路径回退到 `index.html`
- 效果：分享链接可直接访问，不依赖本地文件协议

