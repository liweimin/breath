# 冥想呼吸引导网页（MVP）技术方案（轻量）

更新时间：2026-02-18

本文档用于在动手开发前，明确最关键的技术决策、边界与实现路径，帮助用 AI 辅助编程时保持收敛与可验收。

## 1. 目标 / 非目标

目标与非目标以 `MVP-需求文档.md` 为准，本文只补充实现相关的约束：

- 目标：浏览器内运行、无需后端；按 4 阶段循环引导；三种提示音仅在“阶段切换”播放一次；总时长到点后“完成当前整轮再停”。
- 非目标：不做阶段内节拍；不做账号同步；不做复杂音频素材库（先用 Web Audio 合成，后续可替换音频文件）。

## 2. 技术栈选择与理由

- `HTML + CSS + Vanilla JS`：最低心智负担、部署简单（双击/静态托管均可）。
- `Web Audio API`：不依赖外部音频文件即可合成 3 种音色；可控音量与包络；跨平台可用。
- 可选（后续）：`localStorage` 保存表单参数；不作为强制依赖。

目录结构（建议）：

- `index.html`：页面结构
- `style.css`：样式与动画
- `app.js`：状态机、计时、音频

## 3. 页面结构（信息架构）

页面分 3 块：

1. 参数区（表单）

- 吸气秒数、暂停1秒数、呼气秒数、暂停2秒数
- 总时长（分钟）
- 音量、静音

1. 控制区（按钮）

- 开始、暂停、继续、停止/重置

1. 引导区（主视觉）

- 当前阶段文案（吸气/暂停/呼气/暂停）
- 阶段剩余秒数
- 总剩余时间（分钟级即可；实现可显示 `mm:ss`）
- 呼吸圆形动画（吸气扩大、呼气缩小、暂停保持）

## 4. 核心状态机（阶段切换与用户控制）

### 4.1 呼吸阶段定义

阶段序列固定为：

- `INHALE`（吸气，X 秒）
- `HOLD_1`（暂停1，Y1 秒，可为 0）
- `EXHALE`（呼气，Z 秒）
- `HOLD_2`（暂停2，Y2 秒，可为 0）

### 4.2 运行状态（Run State）

运行层面的状态建议拆开管理（避免“阶段”和“暂停”混在一起）：

- `IDLE`：未开始/已重置
- `RUNNING`：运行中
- `PAUSED`：暂停中
- `FINISHED`：已结束（到点且完成整轮后）

### 4.3 用户操作的语义

- 开始：从 `IDLE` 进入 `RUNNING`，初始化总时长计时，并“解锁音频”（见第 6 节）。
- 暂停：从 `RUNNING` 进入 `PAUSED`，冻结计时与动画（音频不需要持续播放）。
- 继续：从 `PAUSED` 回到 `RUNNING`，恢复计时与动画。
- 停止/重置：任何状态回到 `IDLE`，清理定时器、重置 UI。

### 4.4 0 秒阶段处理

当 `HOLD_1` 或 `HOLD_2` 为 0：

- 直接跳到下一阶段，不显示倒计时。
- 为避免“连响两声”打断节奏：建议不播放该次暂停音（与 `MVP-需求文档.md` 一致）。

## 5. 计时策略（避免漂移）

计时不建议用“每秒减 1”的方式（会漂移、切后台更明显），而应使用时间戳差值：

- 记录 `phaseEndAtMs`（当前阶段结束的绝对时间戳）。
- 每帧/每 200ms 刷新 UI：`remainingMs = phaseEndAtMs - nowMs`。
- 阶段结束条件：`remainingMs <= 0` 时切到下一阶段，并为下一阶段设置新的 `phaseEndAtMs`。
- 暂停：记录 `pausedAtMs`，恢复时把 `phaseEndAtMs += (nowMs - pausedAtMs)`。

刷新频率建议：

- UI 显示“秒”时，用 `setInterval(200ms)` 足够平滑且省电；
- 动画如需更平滑，可使用 `requestAnimationFrame`，但仍以时间戳计算进度。

## 6. 声音策略（Web Audio + 用户手势限制）

### 6.1 浏览器限制

大多数浏览器要求“用户手势（点击/触摸）”后才允许发声：

- “开始”按钮事件里创建/恢复 `AudioContext`（`audioContext.resume()`）。

### 6.2 三种音色（MVP 合成方案）

只在阶段切换时播放一次（one-shot），并通过包络避免刺耳：

- 吸气（鼓声）：低频 `sine/triangle` + 短促衰减包络（类似 tom/kick）。
- 暂停（水滴）：高频短音 + 快速下滑（pitch drop）+ 短混响感（可用非常短的 `delay` 或简单滤波模拟；MVP 也可先不做混响）。
- 呼气（轻乐器）：`sine`/`triangle` + 轻微泛音（叠加一个高一点的频率）+ 更柔和的 attack/decay（像铃/拇指琴）。

音量控制：

- 一个全局 `GainNode` 作为 master gain，音量滑杆映射到 0–1。
- 静音：直接把 master gain 设为 0（并保留滑杆值以便恢复）。

## 7. 数据与持久化（可选）

可选使用 `localStorage` 保存用户参数（吸/停/呼/停/总时长/音量/静音）：

- 页面加载时读取并填充默认值。
- 用户修改时节流写入（或在点击开始时写入一次）。

## 8. 验收与手工测试清单（MVP）

功能验收以 `MVP-需求文档.md` 为准，开发时建议按下面用例逐个勾选：

- 基础流程：默认参数 → 开始 → 能按顺序走完多个阶段且倒计时准确。
- 声音映射：进入吸气/暂停/呼气时各响一次，且音色能明显区分。
- 0 秒暂停：将 Y1=0 或 Y2=0，能跳过且不中断流程（且不额外发声）。
- 暂停/继续：任意阶段暂停 3–5 秒再继续，阶段剩余时间正确延后，不“跳段”。
- 到点停止：总时长设置很短（如 1 分钟），到点后不立刻停，而是在完成 `HOLD_2` 后停。
- 静音/音量：静音能立即生效且不影响计时；取消静音能恢复音量。
- 切后台：切到别的标签页再回来，计时仍基本正确（允许 UI 刷新不那么频繁，但阶段切换不应乱）。

## 9. 风险点与规避

- 自动播放限制：必须把音频解锁放在“开始”按钮事件里。
- 计时漂移：使用“绝对时间戳”而非“每秒递减”。
- 切后台/省电：用时间戳计算可最大程度保持正确；UI 刷新频率可适当降低。

## 10. 开发阶段拆分（里程碑）

1. 阶段 1：表单 + 控制按钮 + 文字倒计时（先不做声音/动画）
2. 阶段 2：实现阶段状态机 + 到点“完成整轮再停” + 暂停/继续语义正确
3. 阶段 3：接入三种提示音（Web Audio one-shot）
4. 阶段 4：加入呼吸圆形动画 + 总剩余时间显示
5. 阶段 5：打磨（输入校验、0 秒跳过、可选 localStorage、移动端样式）

